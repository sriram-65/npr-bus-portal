{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4 fw-bold">ðŸ“š Student Attendance History</h2>

  <div id="loading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p>Fetching your attendance history...</p>
  </div>

  <div class="table-responsive" id="historyTableContainer" style="display:none;">
    <table class="table table-striped table-hover align-middle shadow-sm rounded">
      <thead class="table-primary">
        <tr class="text-center">
          <th>Date</th>
          <th>Status</th>
          <th>Bus No</th>
          <th>Attendaced By</th>

        </tr>
      </thead>
      <tbody id="historyTableBody" class="text-center"></tbody>
    </table>
  </div>

  <div id="emptyMsg" class="text-center text-muted my-4" style="display:none;">
    <p>No attendance history found.</p>
  </div>
</div>

<script>
  const API_URL = 'https://npr-bus-backend.vercel.app';

  async function loadAttendanceHistory() {
    try {
      const res = await fetch(`${API_URL}/api/history`, {
        credentials: "include"
      });
      const result = await res.json();

      const loading = document.getElementById('loading');
      const tableContainer = document.getElementById('historyTableContainer');
      const tableBody = document.getElementById('historyTableBody');
      const emptyMsg = document.getElementById('emptyMsg');

      loading.style.display = "none";

      if (!result.Success || !result.data.length) {
        emptyMsg.style.display = "block";
        return;
      }

      tableContainer.style.display = "block";
      tableBody.innerHTML = "";

      result.data.forEach((record) => {
        const statusBadge = record.otp_verfied
          ? '<span class="badge bg-success">Present</span>'
          : '<span class="badge bg-danger">Absent</span>';

        const attendBy = record.Attendanced_By ? record.Attendanced_By : 'â€”';

        const row = `
          <tr>
            <td style='font-size:15px;'>${new Date(record.created_at).toDateString()}</td>
            <td>${statusBadge}</td>
            <td>${record.busno}</td>
            <td>${attendBy}</td>
            
          </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
      });
    } catch (error) {
      console.error("Error loading history:", error);
      document.getElementById('loading').innerHTML = "<p class='text-danger'>Failed to load data.</p>";
    }
  }

  loadAttendanceHistory();
</script>
{% endblock %}
